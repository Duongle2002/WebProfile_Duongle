@model List<MyWebProfile.Models.ContentSettings>
@using System.Collections.Generic;
@{
    ViewData["Title"] = "Qu·∫£n l√Ω n·ªôi dung trang ch√≠nh";
    Layout = "_AdminLayout";

    // Danh s√°ch key m·∫∑c ƒë·ªãnh cho t·ª´ng nh√≥m
    var defaultKeys = new List<(string Key, string Category, string Description)>
    {
                 // About/Gi·ªõi thi·ªáu
         ("AboutName", "About", "T√™n c·ªßa b·∫°n hi·ªÉn th·ªã trong ph·∫ßn Gi·ªõi thi·ªáu"),
         ("AboutTitle", "About", "Ti√™u ƒë·ªÅ ch·ª©c danh (v√≠ d·ª•: Full Stack Developer)"),
         ("AboutDescription", "About", "M√¥ t·∫£ chi ti·∫øt v·ªÅ b·∫£n th√¢n (h·ªó tr·ª£ HTML: <strong>, <em>, <br>)"),
         ("CareerStartYear", "About", "NƒÉm b·∫Øt ƒë·∫ßu s·ª± nghi·ªáp (d·ª± ph√≤ng n·∫øu kh√¥ng c√≥ kinh nghi·ªám l√†m vi·ªác)"),
         ("CareerStartDate", "About", "Ng√†y b·∫Øt ƒë·∫ßu s·ª± nghi·ªáp (ƒë·ªãnh d·∫°ng: 2019-01-01 - d·ª± ph√≤ng n·∫øu kh√¥ng c√≥ kinh nghi·ªám l√†m vi·ªác)"),
         ("BaseClients", "About", "S·ªë kh√°ch h√†ng c∆° b·∫£n (m·∫∑c ƒë·ªãnh: 30)"),
         ("ClientsPerYear", "About", "S·ªë kh√°ch h√†ng tƒÉng m·ªói nƒÉm (m·∫∑c ƒë·ªãnh: 5)"),
         ("BaseProjects", "About", "S·ªë d·ª± √°n c∆° b·∫£n (m·∫∑c ƒë·ªãnh: 0, s·∫Ω c·ªông v·ªõi d·ª± √°n t·ª´ database)"),
         ("ShowCalculationInfo", "About", "Hi·ªÉn th·ªã tooltip c√¥ng th·ª©c t√≠nh (True/False)"),
         // Kinh nghi·ªám
         ("ExperienceTitle", "Experience", "Ti√™u ƒë·ªÅ ph·∫ßn Kinh nghi·ªám l√†m vi·ªác"),
         ("ExperienceDescription", "Experience", "M√¥ t·∫£ ph·∫ßn Kinh nghi·ªám"),
         // D·ª± √°n
         ("ProjectTitle", "Project", "Ti√™u ƒë·ªÅ ph·∫ßn D·ª± √°n ƒë√£ th·ª±c hi·ªán"),
         ("ProjectDescription", "Project", "M√¥ t·∫£ ph·∫ßn D·ª± √°n"),
         // Li√™n h·ªá
         ("ContactEmail", "Contact", "Email li√™n h·ªá (hi·ªÉn th·ªã trong ph·∫ßn Contact)"),
         ("ContactPhone", "Contact", "S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá"),
         ("ContactAddress", "Contact", "ƒê·ªãa ch·ªâ l√†m vi·ªác"),
         ("ContactGithub", "Contact", "Link GitHub c√° nh√¢n"),
         ("ContactLinkedin", "Contact", "Link LinkedIn c√° nh√¢n"),
         ("ContactTwitter", "Contact", "Link Twitter c√° nh√¢n"),
         ("ContactFacebook", "Contact", "Link Facebook c√° nh√¢n"),
         ("ContactInstagram", "Contact", "Link Instagram c√° nh√¢n"),
         ("ContactYoutube", "Contact", "Link YouTube c√° nh√¢n"),
         // Hero
         ("HeroName", "Hero", "T√™n hi·ªÉn th·ªã ·ªü ƒë·∫ßu trang (Hero section)"),
         ("HeroTitle", "Hero", "Ch·ª©c danh/c√¥ng vi·ªác ch√≠nh"),
         ("HeroLocation", "Hero", "ƒê·ªãa ƒëi·ªÉm l√†m vi·ªác (v√≠ d·ª•: H√† N·ªôi, Vi·ªát Nam)"),
         ("HeroImage", "Hero", "URL ·∫£nh ƒë·∫°i di·ªán (hi·ªÉn th·ªã ·ªü Hero section)"),
         ("HeroPortfolioButton", "Hero", "Text n√∫t Portfolio (m·∫∑c ƒë·ªãnh: Xem Portfolio)"),
         ("HeroContactButton", "Hero", "Text n√∫t Li√™n h·ªá (m·∫∑c ƒë·ªãnh: Li√™n h·ªá)"),
         // Navigation
         ("NavigationLogo", "Navigation", "Logo hi·ªÉn th·ªã trong menu navigation"),
         // Footer
         ("FooterCopyright", "Footer", "Text copyright ·ªü cu·ªëi trang"),
         ("FooterDescription", "Footer", "M√¥ t·∫£ ng·∫Øn ·ªü footer")
    };

    // K·∫øt h·ª£p key m·∫∑c ƒë·ªãnh v√† key trong database (Model)
    var allKeys = new List<(string Key, string Category, string Description, string Value, DateTime UpdatedAt)>();
    var usedKeys = new HashSet<string>();
    foreach (var def in defaultKeys)
    {
        var exist = Model.FirstOrDefault(x => x.Key == def.Key);
        if (exist != null)
        {
            allKeys.Add((def.Key, def.Category, def.Description, exist.Value, exist.UpdatedAt));
            usedKeys.Add(def.Key);
        }
        else
        {
            allKeys.Add((def.Key, def.Category, def.Description, "", DateTime.Now));
        }
    }
    // Th√™m c√°c key kh√°c c√≥ trong database nh∆∞ng kh√¥ng n·∫±m trong danh s√°ch m·∫∑c ƒë·ªãnh
    foreach (var setting in Model)
    {
        if (!usedKeys.Contains(setting.Key))
        {
            allKeys.Add((setting.Key, setting.Category, setting.Description, setting.Value, setting.UpdatedAt));
        }
    }
}

 <div class="d-flex justify-content-between align-items-center mb-4">
     <div>
         <h2>Qu·∫£n l√Ω n·ªôi dung trang ch√≠nh</h2>
         <p>Ch·ªânh s·ª≠a n·ªôi dung tƒ©nh hi·ªÉn th·ªã tr√™n trang ch√≠nh</p>
     </div>
     <div>
         <a href="@Url.Action("PreviewMainPage", "Admin")" class="btn btn-primary" target="_blank">
             <i class="fas fa-eye"></i> Xem tr∆∞·ªõc trang ch√≠nh
         </a>
     </div>
 </div>
 
 <!-- H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng -->
 <div class="alert alert-info mb-4">
     <h6><i class="fas fa-info-circle"></i> H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:</h6>
     <ul class="mb-0">
         <li><strong>Key:</strong> T√™n ƒë·ªãnh danh c·ªßa n·ªôi dung (kh√¥ng thay ƒë·ªïi)</li>
         <li><strong>M√¥ t·∫£:</strong> Gi·∫£i th√≠ch n·ªôi dung n√†y hi·ªÉn th·ªã ·ªü ƒë√¢u v√† l√†m g√¨</li>
         <li><strong>Gi√° tr·ªã hi·ªán t·∫°i:</strong> N·ªôi dung ƒëang hi·ªÉn th·ªã tr√™n trang ch√≠nh</li>
         <li><strong>Thao t√°c:</strong> Click v√†o n√∫t <i class="fas fa-edit"></i> ho·∫∑c click v√†o b·∫•t k·ª≥ √¥ n√†o ƒë·ªÉ ch·ªânh s·ª≠a</li>
     </ul>
 </div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">N·ªôi dung hi·ªán t·∫°i</h5>
                <small class="text-muted">T·∫•t c·∫£ n·ªôi dung c√≥ th·ªÉ ch·ªânh s·ª≠a</small>
            </div>
            <div class="card-body">
                <!-- B·ªô l·ªçc -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="searchInput" class="form-label">T√¨m ki·∫øm</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="T√¨m theo key ho·∫∑c gi√° tr·ªã...">
                    </div>
                    <div class="col-md-3">
                        <label for="categoryFilter" class="form-label">Danh m·ª•c</label>
                        <select class="form-control" id="categoryFilter">
                            <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                            <option value="Hero">Hero</option>
                            <option value="About">About</option>
                            <option value="Contact">Contact</option>
                            <option value="Navigation">Navigation</option>
                            <option value="Footer">Footer</option>
                            <option value="General">General</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="sortOrder" class="form-label">S·∫Øp x·∫øp</label>
                        <select class="form-control" id="sortOrder">
                            <option value="az">A-Z</option>
                            <option value="za">Z-A</option>
                            <option value="category">Theo danh m·ª•c</option>
                            <option value="updated">C·∫≠p nh·∫≠t g·∫ßn nh·∫•t</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times"></i> X√≥a l·ªçc
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover" id="contentTable">
                                                 <thead>
                             <tr>
                                 <th>Key</th>
                                 <th>M√¥ t·∫£</th>
                                 <th>Gi√° tr·ªã hi·ªán t·∫°i</th>
                                 <th>Danh m·ª•c</th>
                                 <th>C·∫≠p nh·∫≠t</th>
                                 <th>Thao t√°c</th>
                             </tr>
                         </thead>
                        <tbody>
                            @foreach (var item in allKeys)
                            {
                                <tr data-key="@item.Key" data-category="@item.Category" data-value="@item.Value">
                                    <td><strong>@item.Key</strong></td>
                                    <td><small class="text-muted">@item.Description</small></td>
                                                                         <td>
                                         <div class="content-value">
                                             @if (!string.IsNullOrEmpty(item.Value) && item.Value.Length > 50)
                                             {
                                                 <div class="content-preview">@item.Value.Substring(0, 50)<text>...</text></div>
                                                 <div class="content-full" style="display: none;">@item.Value</div>
                                                 <button type="button" class="btn btn-sm btn-link toggle-content" data-target="@item.Key"><i class="fas fa-eye"></i> Xem th√™m</button>
                                                 @if (item.Key == "AboutDescription")
                                                 {
                                                     <button type="button" class="btn btn-sm btn-link preview-html" data-content="@item.Value"><i class="fas fa-eye"></i> Xem HTML</button>
                                                 }
                                             }
                                             else
                                             {
                                                 <div class="content-full">@item.Value</div>
                                                 @if (item.Key == "AboutDescription")
                                                 {
                                                     <button type="button" class="btn btn-sm btn-link preview-html" data-content="@item.Value"><i class="fas fa-eye"></i> Xem HTML</button>
                                                 }
                                             }
                                         </div>
                                     </td>
                                    <td>
                                        <span class="badge bg-secondary">@item.Category</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            @item.UpdatedAt.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary edit-content" 
                                                data-key="@item.Key" 
                                                data-value="@item.Value" 
                                                data-category="@item.Category">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Hi·ªÉn th·ªã <span id="visibleCount">@allKeys.Count</span> / <span id="totalCount">@allKeys.Count</span> n·ªôi dung
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card sticky-form">
            <div class="card-header">
                <h5 class="mb-0">Th√™m/Ch·ªânh s·ª≠a n·ªôi dung</h5>
            </div>
            <div class="card-body">
                <form id="contentForm">
                    <div class="mb-3">
                        <label for="contentKey" class="form-label">Key</label>
                        <input type="text" class="form-control" id="contentKey" name="key" required>
                        <div class="form-text">V√≠ d·ª•: HeroName, AboutTitle, ContactEmail</div>
                    </div>
                    
                                         <div class="mb-3">
                         <label for="contentValue" class="form-label">Gi√° tr·ªã</label>
                         <textarea class="form-control" id="contentValue" name="value" rows="3" required></textarea>
                         <div id="htmlPreview" class="mt-2" style="display: none;">
                             <small class="text-muted">Preview:</small>
                             <div class="border p-2 bg-light rounded" id="previewContent"></div>
                         </div>
                     </div>
                    
                    <div class="mb-3">
                        <label for="contentCategory" class="form-label">Danh m·ª•c</label>
                        <select class="form-control" id="contentCategory" name="category">
                            <option value="Hero">Hero</option>
                            <option value="About">About</option>
                            <option value="Contact">Contact</option>
                            <option value="Navigation">Navigation</option>
                            <option value="Footer">Footer</option>
                            <option value="General">General</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-save"></i> L∆∞u thay ƒë·ªïi
                    </button>
                </form>
            </div>
        </div>
        
                 <div class="card mt-3">
             <div class="card-header">
                 <h6 class="mb-0">L∆∞u √Ω quan tr·ªçng</h6>
             </div>
             <div class="card-body">
                 <small class="text-muted">
                     <strong>üìä N·ªôi dung ƒë·ªông:</strong> Th·ªëng k√™ d·ª± √°n, kinh nghi·ªám ƒë∆∞·ª£c t√≠nh t·ª± ƒë·ªông t·ª´ database<br>
                     <strong>üìù N·ªôi dung tƒ©nh:</strong> T√™n, m√¥ t·∫£, th√¥ng tin li√™n h·ªá c√≥ th·ªÉ ch·ªânh s·ª≠a ·ªü ƒë√¢y<br>
                     <strong>üîß Th·ª© t·ª± hi·ªÉn th·ªã:</strong> Qu·∫£n l√Ω trong "Qu·∫£n l√Ω th·ª© t·ª± hi·ªÉn th·ªã"<br>
                     <strong>üíª HTML Support:</strong> AboutDescription h·ªó tr·ª£ HTML (v√≠ d·ª•: &lt;strong&gt;, &lt;em&gt;, &lt;br&gt;)<br>
                     <strong>üëÅÔ∏è Preview:</strong> Click "Xem tr∆∞·ªõc trang ch√≠nh" ƒë·ªÉ xem thay ƒë·ªïi<br>
                     <strong>üìÖ C√°ch t√≠nh s·ªë nƒÉm kinh nghi·ªám:</strong><br>
                     &nbsp;&nbsp;‚Ä¢ ∆Øu ti√™n 1: NƒÉm nh·ªè nh·∫•t t·ª´ kinh nghi·ªám l√†m vi·ªác trong database<br>
                     &nbsp;&nbsp;‚Ä¢ ∆Øu ti√™n 2: CareerStartDate (ƒë·ªãnh d·∫°ng: 2019-01-01)<br>
                     &nbsp;&nbsp;‚Ä¢ ∆Øu ti√™n 3: CareerStartYear (ch·ªâ nƒÉm: 2019)<br>
                     &nbsp;&nbsp;‚Ä¢ C√¥ng th·ª©c: (Ng√†y hi·ªán t·∫°i - Ng√†y b·∫Øt ƒë·∫ßu) √∑ 365.25
                 </small>
             </div>
         </div>
    </div>
</div>

<style>
.content-value {
    max-width: 300px;
}

.content-preview, .content-full {
    word-wrap: break-word;
}

.toggle-content {
    padding: 0;
    font-size: 0.8rem;
    color: #007bff;
}

.edit-content {
    padding: 0.25rem 0.5rem;
}

.sticky-form {
    position: sticky;
    top: 2rem;
    z-index: 100;
}

@@media (max-width: 768px) {
    .sticky-form {
        position: static;
    }
}
</style>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Toggle content preview/full
            $('.toggle-content').click(function() {
                var target = $(this).data('target');
                var preview = $(this).siblings('.content-preview');
                var full = $(this).siblings('.content-full');
                
                if (preview.is(':visible')) {
                    preview.hide();
                    full.show();
                    $(this).html('<i class="fas fa-eye-slash"></i> Thu g·ªçn');
                } else {
                    full.hide();
                    preview.show();
                    $(this).html('<i class="fas fa-eye"></i> Xem th√™m');
                }
            });
            
            // Edit content (n√∫t ch·ªânh s·ª≠a)
            $('.edit-content').click(function(e) {
                e.stopPropagation();
                var key = $(this).data('key');
                var value = $(this).data('value');
                var category = $(this).data('category');
                
                $('#contentKey').val(key);
                $('#contentValue').val(value);
                $('#contentCategory').val(category);
                
                // Scroll to form
                $('html, body').animate({
                    scrollTop: $('#contentForm').offset().top - 100
                }, 500);
            });
            
            // Khi nh·∫•n v√†o b·∫•t k·ª≥ √¥ n√†o (tr·ª´ n√∫t thao t√°c) c·ªßa h√†ng => chuy·ªÉn sang c·∫≠p nh·∫≠t
            $('#contentTable tbody tr td').not(':last-child').on('click', function() {
                var row = $(this).closest('tr');
                var key = row.data('key');
                var value = row.data('value');
                var category = row.data('category');
                $('#contentKey').val(key);
                $('#contentValue').val(value);
                $('#contentCategory').val(category);
                $('html, body').animate({
                    scrollTop: $('#contentForm').offset().top - 100
                }, 500);
            });
            
            // Submit form
            $('#contentForm').submit(function(e) {
                e.preventDefault();
                
                var formData = {
                    key: $('#contentKey').val(),
                    value: $('#contentValue').val(),
                    category: $('#contentCategory').val()
                };
                
                $.ajax({
                    url: '@Url.Action("UpdateMainPageContent", "Admin")',
                    type: 'POST',
                    data: formData,
                    success: function(response) {
                        if (response.success) {
                            alert('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
                            location.reload();
                        } else {
                            alert('L·ªói: ' + response.message);
                        }
                    },
                    error: function() {
                        alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t!');
                    }
                });
            });
            
            // Filter functionality
            function applyFilters() {
                var searchTerm = $('#searchInput').val().toLowerCase();
                var categoryFilter = $('#categoryFilter').val();
                var sortOrder = $('#sortOrder').val();
                
                var rows = $('#contentTable tbody tr');
                var visibleCount = 0;
                
                rows.each(function() {
                    var row = $(this);
                    var key = row.data('key').toLowerCase();
                    var value = row.data('value').toLowerCase();
                    var category = row.data('category');
                    
                    var matchesSearch = key.includes(searchTerm) || value.includes(searchTerm);
                    var matchesCategory = !categoryFilter || category === categoryFilter;
                    
                    if (matchesSearch && matchesCategory) {
                        row.show();
                        visibleCount++;
                    } else {
                        row.hide();
                    }
                });
                
                $('#visibleCount').text(visibleCount);
                
                // Sort rows
                var tbody = $('#contentTable tbody');
                var sortedRows = rows.toArray().sort(function(a, b) {
                    var aKey = $(a).data('key');
                    var bKey = $(b).data('key');
                    var aCategory = $(a).data('category');
                    var bCategory = $(b).data('category');
                    
                    switch(sortOrder) {
                        case 'az':
                            return aKey.localeCompare(bKey);
                        case 'za':
                            return bKey.localeCompare(aKey);
                        case 'category':
                            return aCategory.localeCompare(bCategory) || aKey.localeCompare(bKey);
                        default:
                            return 0;
                    }
                });
                
                tbody.empty().append(sortedRows);
            }
            
            // Bind filter events
            $('#searchInput, #categoryFilter, #sortOrder').on('input change', applyFilters);
            
            // Clear filters function
            window.clearFilters = function() {
                $('#searchInput').val('');
                $('#categoryFilter').val('');
                $('#sortOrder').val('az');
                applyFilters();
            };
            
                         // Initial filter
             applyFilters();
             
             // HTML Preview functionality
             $('.preview-html').click(function() {
                 var content = $(this).data('content');
                 $('#previewContent').html(content);
                 $('#htmlPreview').show();
             });
             
             // Auto preview for AboutDescription
             $('#contentValue').on('input', function() {
                 var key = $('#contentKey').val();
                 if (key === 'AboutDescription') {
                     var content = $(this).val();
                     $('#previewContent').html(content);
                     $('#htmlPreview').show();
                 } else {
                     $('#htmlPreview').hide();
                 }
             });
         });
     </script>
} 